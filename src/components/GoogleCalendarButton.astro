---
import { randomUUID } from "node:crypto";

const {
  text = "Book an appointment",
  color = "#039BE5",
  className = "primary-btn-1 btn-hover",
  wrapperClass = "",
  ariaLabel = "Schedule an appointment with MAC Paving",
  schedulingUrl =
    "https://calendar.google.com/calendar/appointments/schedules/AcZssZ2f2-a8hsmFRdKAdT1bvjgeib5aUhRroNwmyM-fq0U3_9Y7cAp5Qw3vk9NztACX34Ggtqf1JxI-?gv=true",
} = Astro.props;

const targetId = `google-calendar-button-${randomUUID()}`;
const wrapperClasses = ["google-calendar-button-wrapper", wrapperClass]
  .filter(Boolean)
  .join(" ");

// Serializamos en el lado del servidor y pasamos variables al script del cliente.
const BUTTON_CONFIG = { url: schedulingUrl, color, label: text };
const TARGET_ID = targetId;
const BUTTON_CLASSES = className;
---

<div
  id={targetId}
  class={wrapperClasses}
  aria-label={ariaLabel}
  data-button-classes={className}
></div>

<!-- Importante: no usar TypeScript en el script del cliente y evitar JSON.parse con strings anidados. -->
<script define:vars={{ BUTTON_CONFIG, TARGET_ID, BUTTON_CLASSES }}>
  function initializeButton() {
    const target = document.getElementById(TARGET_ID);
    const loader = window?.calendar?.schedulingButton?.load;

    if (!target || typeof loader !== "function") return;

    // Limpiar contenido previo del target para evitar duplicados.
    target.innerHTML = "";

    loader({
      ...BUTTON_CONFIG,
      target,
    });

    if (BUTTON_CLASSES) {
      const buttonElement = target.querySelector("button, a");
      if (buttonElement) {
        BUTTON_CLASSES.split(/\s+/)
          .filter(Boolean)
          .forEach((c) => buttonElement.classList.add(c));
      }
    }
  }

  function ensureStylesLoaded() {
    if (document.querySelector('link[data-google-calendar-css]')) return;

    const existingHref =
      'https://calendar.google.com/calendar/scheduling-button-script.css';
    let linkEl = document.querySelector(`link[href="${existingHref}"]`);

    if (!linkEl) {
      linkEl = document.createElement("link");
      linkEl.rel = "stylesheet";
      linkEl.href = existingHref;
      document.head.appendChild(linkEl);
    }

    linkEl.setAttribute("data-google-calendar-css", "true");
  }

  function loadGoogleScript() {
    const handleScriptLoad = () => {
      const script = document.querySelector(
        'script[data-google-calendar-button="true"]'
      );
      if (script) script.setAttribute("data-loaded", "true");
      initializeButton();
    };

    // Si ya estÃ¡ disponible el loader, inicializamos de inmediato.
    const loader = window?.calendar?.schedulingButton?.load;
    if (typeof loader === "function") {
      initializeButton();
      return;
    }

    let script = document.querySelector(
      'script[data-google-calendar-button="true"]'
    );

    if (!script) {
      script = document.createElement("script");
      script.src =
        "https://calendar.google.com/calendar/scheduling-button-script.js";
      script.async = true;
      script.setAttribute("data-google-calendar-button", "true");
      script.addEventListener("load", handleScriptLoad, { once: true });
      document.body.appendChild(script);
    } else if (script.getAttribute("data-loaded") === "true") {
      initializeButton();
    } else {
      script.addEventListener("load", handleScriptLoad, { once: true });
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    ensureStylesLoaded();
    loadGoogleScript();
  });
</script>